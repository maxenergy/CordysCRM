# CordysCRM 项目改进路线图

**基于**: PROJECT_COMPREHENSIVE_ANALYSIS.md  
**创建时间**: 2024-12-27  
**状态**: 🚀 执行中

---

## 执行摘要

基于 Gemini MCP 和 Codex MCP 的全面分析,我们识别出 **12 个关键问题**,并已为其中 **6 个最高优先级问题**创建了完整的 Spec 文档。

### 当前进展

| 优先级 | 问题总数 | 已创建 Spec | 已实施 | 完成率 |
|--------|---------|------------|--------|--------|
| P0 | 3 | 3 | 0 | 0% |
| P1 | 3 | 3 | 0 | 0% |
| P2 | 6 | 0 | 0 | 0% |
| **总计** | **12** | **6** | **0** | **0%** |

---

## 一、P0 级别问题（必须立即修复）

### ✅ 问题 1: 同步状态管理缺陷

**Spec**: `.kiro/specs/core-data-integrity/`  
**状态**: 📝 Spec 已完成，待实施  
**影响**: 数据永久丢失

**问题描述**:
- `inProgress` 状态的队列项如果在同步中崩溃将永远不会再被处理
- 只拉取 `pending` 和 `failed` 项

**解决方案**:
- 启动时重置长时间 inProgress 的项（超过 5 分钟）
- 区分可重试和不可重试错误
- 修复无 API client 时丢数据问题

**实施计划**:
- Phase 1: Flutter 同步状态自愈（5 个任务）
- Phase 2: 错误分类与重试策略（7 个任务）

---

### ✅ 问题 2: 数据采集脆弱性

**Spec**: `.kiro/specs/extension-resilient-scraping/`  
**状态**: 📝 Spec 已完成，待实施  
**影响**: 核心功能不可用

**问题描述**:
- CSS 选择器依赖第三方页面结构
- 页面改版立即失效

**解决方案**:
- 配置化提取规则（支持热更新）
- 多策略提取（CSS/JSON-LD/Regex/XPath）
- Canary 自动化测试（每日监测）
- 降级到手动模式

**实施计划**:
- Phase 1: 配置化提取规则（8 个任务）
- Phase 2: 多策略提取引擎（7 个任务）
- Phase 3: Canary 测试和监控（7 个任务）

---

### ✅ 问题 3: 企业去重规范化不足

**Spec**: `.kiro/specs/core-data-integrity/`  
**状态**: 📝 Spec 已完成，待实施  
**影响**: 重复导入，数据冗余

**问题描述**:
- `creditCode` 不 trim/upper
- 存在全半角/大小写/空白导致重复导入

**解决方案**:
- 信用代码标准化（trim + upper + 全半角转换）
- 数据库唯一索引
- 历史数据清洗

**实施计划**:
- Phase 1: 后端数据规范化（7 个任务）
- Phase 2: 历史数据清理（5 个任务）

---

## 二、P1 级别问题（高优先级）

### ✅ 问题 4: 本地搜索性能问题

**Spec**: `.kiro/specs/enterprise-search-pagination/`  
**状态**: 📝 Spec 已完成，待实施  
**影响**: 大数据量下内存/性能问题

**问题描述**:
- 全量加载再分页
- 硬编码 `LIMIT 50`
- 用户无法访问超过 50 条的记录

**解决方案**:
- SQL 层分页（LIMIT offset, size）
- 添加 count 查询
- 修复混合搜索逻辑

**实施计划**:
- Phase 1: Mapper 层分页（5 个任务）
- Phase 2: Service 层重构（6 个任务）
- Phase 3: 混合搜索优化（4 个任务）
- Phase 4: 性能测试（4 个任务）

---

### ✅ 问题 5: AI 成本计算硬编码

**Spec**: `.kiro/specs/ai-cost-configuration/`  
**状态**: 📝 Spec 已完成，待实施  
**影响**: 成本追踪不准确

**问题描述**:
- 硬编码费率 $0.01/1000 tokens
- 无法区分不同模型
- 无法区分输入/输出 token

**解决方案**:
- 数据库存储定价配置
- 内存缓存 + 自动刷新
- 分离输入/输出 token 定价
- REST API 管理定价

**实施计划**:
- Phase 1: 数据库 Schema（4 个任务）
- Phase 2: 定价服务（6 个任务）
- Phase 3: AI 服务集成（5 个任务）
- Phase 4: 缓存管理（4 个任务）
- Phase 5: REST API（4 个任务）
- Phase 6: 数据迁移（4 个任务）

---

### ✅ 问题 6: 无 API Client 时丢数据

**Spec**: `.kiro/specs/core-data-integrity/`  
**状态**: 📝 Spec 已完成，待实施  
**影响**: 离线数据被丢弃

**问题描述**:
```dart
if (_apiClient == null) {
  // 直接模拟成功并删除队列项
  await _database.syncQueueDao.delete(item.id);
  return;
}
```

**解决方案**:
- 保留队列项，等待 client 可用
- 提供 API Client 状态监听
- 明确的错误提示

**实施计划**:
- 包含在 core-data-integrity Spec 的 Phase 1

---

## 三、P2 级别问题（中优先级）

### ⏳ 问题 7: Chrome Extension 导入按钮缺失

**Spec**: 待创建  
**状态**: 🔴 未开始  
**影响**: SPA 路由切换后按钮消失

**问题描述**:
- `init()` 若已有容器直接返回
- 从列表页切到详情页时不会补上按钮

**建议方案**:
- 监听 URL 变化
- 检查页面类型并更新按钮状态
- 或销毁后重建

---

### ⏳ 问题 8: JWT Token 明文存储

**Spec**: 待创建  
**状态**: 🔴 未开始  
**影响**: 安全风险

**问题描述**:
- Token 明文存储在 `chrome.storage.local`

**建议方案**:
- 使用 CryptoJS 加密存储
- 密钥从环境变量读取
- 至少对本地持久化做简单保护

---

### ⏳ 问题 9: WebView 内存泄漏风险

**Spec**: 待创建  
**状态**: 🔴 未开始  
**影响**: 长时间使用内存占用高

**问题描述**:
- `EnterpriseSearchWithWebViewPage` 常驻 WebView

**建议方案**:
- 非搜索场景销毁 WebView 实例
- 进入搜索页时重建

---

### ⏳ 问题 10: 同步队列串行处理

**Spec**: 待创建  
**状态**: 🔴 未开始  
**影响**: 高负载下同步慢

**问题描述**:
- 逐条串行处理同步队列

**建议方案**:
- 批量推送
- 并发处理（限制并发数）

---

### ⏳ 问题 11: 全页面扫描提取

**Spec**: 待创建  
**状态**: 🔴 未开始  
**影响**: 采集性能差

**问题描述**:
- `document.body.innerText` 全文匹配

**建议方案**:
- 限定提取范围
- 使用更精确的选择器

---

### ⏳ 问题 12: AI 失败前置返回不写日志

**Spec**: 待创建  
**状态**: 🔴 未开始  
**影响**: 审计日志不完整

**问题描述**:
- Provider 未注册/不可用时直接返回 failure
- 不会落库日志

**建议方案**:
- 在所有失败分支写日志
- 记录失败原因

---

## 四、实施优先级排序

### 立即执行（本周内）

#### 1. 企业搜索分页优化 (P1)
**Spec**: `enterprise-search-pagination`  
**预估工作量**: 3 人日  
**风险等级**: 低  
**理由**: 
- 修复数据可访问性 bug
- 相对低风险（SQL 变更）
- 快速提升用户满意度

**执行步骤**:
1. 修改 `ExtEnterpriseProfileMapper.xml` 添加分页参数
2. 更新 `EnterpriseService` 使用 SQL 分页
3. 添加 count 查询
4. 运行属性测试验证

---

#### 2. 同步状态自愈 (P0)
**Spec**: `core-data-integrity` (Phase 1)  
**预估工作量**: 2 人日  
**风险等级**: 中  
**理由**:
- 防止数据永久丢失
- 影响用户信任
- 实现相对简单

**执行步骤**:
1. 添加 `_resetStaleInProgressItems()` 方法
2. 在 `initialize()` 中调用
3. 添加属性测试
4. 集成测试验证

---

### 短期执行（本月内）

#### 3. 企业去重规范化 (P0)
**Spec**: `core-data-integrity` (Phase 2)  
**预估工作量**: 3 人日  
**风险等级**: 中  
**理由**:
- 防止重复数据
- 需要数据迁移
- 影响数据质量

**执行步骤**:
1. 实现 `CreditCodeNormalizer` 工具类
2. 更新 `EnterpriseService` 调用规范化
3. 编写数据清理 SQL
4. 执行迁移并验证

---

#### 4. AI 成本配置化 (P1)
**Spec**: `ai-cost-configuration`  
**预估工作量**: 5 人日  
**风险等级**: 中  
**理由**:
- 提升成本追踪准确性
- 支持多模型定价
- 可独立部署

**执行步骤**:
1. 创建数据库表和迁移
2. 实现 `AiModelPricingService`
3. 集成到 `AIService`
4. 添加 REST API
5. 运行属性测试

---

### 中期执行（下季度）

#### 5. 采集规则配置化 (P0)
**Spec**: `extension-resilient-scraping`  
**预估工作量**: 8 人日  
**风险等级**: 高  
**理由**:
- 降低采集脆弱性
- 需要大量重构
- 需要 Canary 测试基础设施

**执行步骤**:
1. 设计配置 JSON Schema
2. 实现多策略提取引擎
3. 重构 `extractor.ts`
4. 实现远程配置更新
5. 建立 Canary 测试
6. 部署监控告警

---

#### 6. 错误分类与重试 (P0)
**Spec**: `core-data-integrity` (Phase 1)  
**预估工作量**: 3 人日  
**风险等级**: 中  
**理由**:
- 优化同步效率
- 节省电量和流量
- 提升用户体验

---

### 长期规划（明年）

#### 7. 官方 API 接入
**预估工作量**: 20 人日  
**风险等级**: 低  
**理由**:
- 彻底解决采集脆弱性
- 提升数据质量
- 合规性保障

---

#### 8. 架构升级
**预估工作量**: 40 人日  
**风险等级**: 高  
**理由**:
- 微服务拆分
- 消息队列引入
- 分布式缓存

---

## 五、Spec 统计

| Spec | 需求数 | 属性数 | 任务数 | 阶段数 | 优先级 | 状态 |
|------|--------|--------|--------|--------|--------|------|
| core-data-integrity | 8 | 10 | 19 | 2 | P0 | 📝 已完成 |
| extension-resilient-scraping | 10 | 8 | 22 | 3 | P0 | 📝 已完成 |
| enterprise-search-pagination | 8 | 8 | 19 | 4 | P1 | 📝 已完成 |
| ai-cost-configuration | 8 | 8 | 27 | 6 | P1 | 📝 已完成 |
| **总计** | **34** | **34** | **87** | **15** | - | - |

---

## 六、测试策略

所有 Spec 遵循统一的测试策略:

### 双重测试方法
- **单元测试**: 特定示例、边界条件、错误处理
- **属性测试**: 通用属性跨所有输入（100+ 迭代）

### 属性测试配置
- 每个 Spec 5-8 个正确性属性
- 每个属性映射到特定需求
- 最小 100 次迭代
- 使用 jqwik (Java) 进行后端测试

### 集成测试
- 端到端场景与真实数据库
- 大数据集性能测试
- 错误处理和降级场景

---

## 七、部署策略

### Phase 1: 低风险修复（第 1-2 周）
1. ✅ enterprise-search-pagination (Mapper + Service)
2. ✅ core-data-integrity (同步状态自愈)

### Phase 2: 中风险修复（第 3-4 周）
3. ✅ core-data-integrity (数据规范化)
4. ✅ ai-cost-configuration (定价配置)

### Phase 3: 高风险修复（第 5-8 周）
5. ✅ extension-resilient-scraping (采集重构)
6. ✅ core-data-integrity (错误分类)

---

## 八、成功指标

### 数据完整性
- ✅ 同步成功率 > 99%
- ✅ 数据丢失率 = 0%
- ✅ 重复企业记录 < 0.1%

### 采集稳定性
- ✅ 采集成功率 > 95%
- ✅ Canary 测试通过率 > 90%
- ✅ 页面结构变化响应时间 < 24 小时

### 性能指标
- ✅ 搜索响应时间 < 500ms (P95)
- ✅ 同步队列处理速度 > 10 items/s
- ✅ 内存占用 < 200MB (移动端)

### 成本准确性
- ✅ AI 成本计算误差 < 1%
- ✅ 支持 5+ LLM Provider
- ✅ 定价更新延迟 < 5 分钟

---

## 九、风险管理

### 高风险项
1. **采集规则重构** - 可能影响现有用户
   - 缓解: 灰度发布，保留旧逻辑作为降级
   
2. **数据迁移** - 可能导致数据丢失
   - 缓解: 完整备份，分批迁移，回滚机制

3. **同步逻辑变更** - 可能引入新 bug
   - 缓解: 充分的属性测试，金丝雀部署

### 中风险项
1. **SQL 分页变更** - 可能影响查询性能
   - 缓解: 性能测试，索引优化

2. **定价配置** - 可能导致成本计算错误
   - 缓解: 属性测试，人工审核

---

## 十、下一步行动

### 本周行动项
1. ✅ 开始实施 `enterprise-search-pagination` (Phase 1)
2. ✅ 开始实施 `core-data-integrity` (Phase 1 - 同步状态自愈)
3. ✅ 准备测试环境和数据

### 本月行动项
1. ✅ 完成 P1 级别所有 Spec 实施
2. ✅ 开始 P0 级别采集重构规划
3. ✅ 建立 Canary 测试基础设施

### 下季度行动项
1. ✅ 完成所有 P0 级别问题修复
2. ✅ 创建 P2 级别问题 Spec
3. ✅ 开始官方 API 接入调研

---

## 十一、协作记录

### Gemini MCP 贡献
- 识别搜索 bug 为"数据可访问性"而非仅"性能"
- 发现硬编码 `LIMIT 50` 在 XML 中
- 提出混合搜索合并策略
- 建议数据库支持的定价与缓存

### Codex MCP 贡献
- 分析现有代码结构
- 识别 12 个具体问题并分优先级
- 提供详细代码示例
- 建议属性测试方法

---

**生成时间**: 2024-12-27  
**生成方式**: Kiro Spec Agent (Gemini MCP + Codex MCP 协作)  
**状态**: 🚀 执行中


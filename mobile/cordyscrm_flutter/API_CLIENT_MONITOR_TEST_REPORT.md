# API Client Monitor é›†æˆæµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•ç¯å¢ƒ

- **åç«¯æœåŠ¡**: è¿è¡Œåœ¨ `http://192.168.1.226:8081`
- **Flutter åº”ç”¨**: Android è®¾å¤‡ (PJT110, Android 15 API 35)
- **æµ‹è¯•æ—¥æœŸ**: 2025-12-28
- **æµ‹è¯•ä»»åŠ¡**: Task 14 - API Client ç›‘æ§åŠŸèƒ½

## æµ‹è¯•ç›®æ ‡

éªŒè¯ API Client Monitor èƒ½å¤Ÿï¼š
1. æ­£ç¡®ç›‘æ§ API Client çš„å¯ç”¨æ€§çŠ¶æ€
2. åœ¨ Client ä¸å¯ç”¨æ—¶æš‚åœåŒæ­¥å¹¶ä¿ç•™é˜Ÿåˆ—é¡¹
3. åœ¨ Client æ¢å¤æ—¶è‡ªåŠ¨è§¦å‘åŒæ­¥
4. é˜²æ­¢åœ¨æœªé…ç½®æœåŠ¡å™¨æ—¶é™é»˜ä¸¢å¤±ç¦»çº¿æ•°æ®

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æ­£å¸¸åŒæ­¥æµç¨‹

**å‰ç½®æ¡ä»¶**:
- ç”¨æˆ·å·²ç™»å½•
- API Client å·²é…ç½®å¹¶å¯ç”¨
- ç½‘ç»œè¿æ¥æ­£å¸¸

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºä¸€ä¸ªæ–°å®¢æˆ·ï¼ˆç¦»çº¿æ•°æ®ï¼‰
2. è§‚å¯ŸåŒæ­¥é˜Ÿåˆ—çŠ¶æ€
3. éªŒè¯æ•°æ®æˆåŠŸåŒæ­¥åˆ°æœåŠ¡å™¨

**é¢„æœŸç»“æœ**:
- âœ… æ•°æ®æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—
- âœ… SyncService æ£€æµ‹åˆ° API Client å¯ç”¨
- âœ… æ•°æ®æˆåŠŸæ¨é€åˆ°æœåŠ¡å™¨
- âœ… é˜Ÿåˆ—é¡¹è¢«åˆ é™¤

**å®é™…ç»“æœ**: 
- åº”ç”¨å·²å¯åŠ¨å¹¶è¿è¡Œ
- ç½‘ç»œé€šä¿¡æ­£å¸¸ï¼ˆä»æ—¥å¿—å¯è§ API è¯·æ±‚æˆåŠŸï¼‰
- ä¼æŸ¥æŸ¥æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### åœºæ™¯ 2: API Client ä¸å¯ç”¨

**å‰ç½®æ¡ä»¶**:
- ç”¨æˆ·æœªç™»å½•æˆ– API Client æœªé…ç½®
- æœ‰å¾…åŒæ­¥çš„ç¦»çº¿æ•°æ®

**æµ‹è¯•æ­¥éª¤**:
1. æ¨¡æ‹Ÿ API Client ä¸å¯ç”¨çŠ¶æ€
2. å°è¯•åŒæ­¥æ•°æ®
3. æ£€æŸ¥é˜Ÿåˆ—é¡¹æ˜¯å¦è¢«ä¿ç•™

**é¢„æœŸç»“æœ**:
- âœ… SyncService æ£€æµ‹åˆ° Client ä¸å¯ç”¨
- âœ… æŠ›å‡º `ClientUnavailableException`
- âœ… é˜Ÿåˆ—é¡¹çŠ¶æ€é‡ç½®ä¸º Pending
- âœ… ä¸åˆ é™¤é˜Ÿåˆ—é¡¹
- âœ… æ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯æç¤º

**å®é™…ç»“æœ**: å¾…æµ‹è¯•

### åœºæ™¯ 3: API Client æ¢å¤

**å‰ç½®æ¡ä»¶**:
- API Client ä»ä¸å¯ç”¨å˜ä¸ºå¯ç”¨
- æœ‰å¾…åŒæ­¥çš„é˜Ÿåˆ—é¡¹

**æµ‹è¯•æ­¥éª¤**:
1. é…ç½® API Clientï¼ˆæ¨¡æ‹Ÿç™»å½•ï¼‰
2. è°ƒç”¨ `ApiClientMonitor.setClient()`
3. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨è§¦å‘åŒæ­¥

**é¢„æœŸç»“æœ**:
- âœ… Monitor é€šçŸ¥ç›‘å¬è€…çŠ¶æ€å˜åŒ–
- âœ… SyncService è‡ªåŠ¨è§¦å‘åŒæ­¥
- âœ… é˜Ÿåˆ—é¡¹æˆåŠŸåŒæ­¥

**å®é™…ç»“æœ**: å¾…æµ‹è¯•

### åœºæ™¯ 4: åº”ç”¨é‡å¯åçš„çŠ¶æ€æ¢å¤

**å‰ç½®æ¡ä»¶**:
- åº”ç”¨åœ¨åŒæ­¥è¿‡ç¨‹ä¸­å´©æºƒ
- æœ‰é˜Ÿåˆ—é¡¹å¤„äº InProgress çŠ¶æ€

**æµ‹è¯•æ­¥éª¤**:
1. æ¨¡æ‹Ÿåº”ç”¨å´©æºƒï¼ˆå¼ºåˆ¶å…³é—­ï¼‰
2. é‡æ–°å¯åŠ¨åº”ç”¨
3. æ£€æŸ¥ Stale é¡¹æ˜¯å¦è¢«é‡ç½®

**é¢„æœŸç»“æœ**:
- âœ… SyncStateRecovery æ£€æµ‹åˆ° Stale é¡¹
- âœ… å°† InProgress é¡¹é‡ç½®ä¸º Pending
- âœ… è®°å½•è­¦å‘Šæ—¥å¿—
- âœ… é‡æ–°è§¦å‘åŒæ­¥

**å®é™…ç»“æœ**: å¾…æµ‹è¯•

## å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
1. åç«¯æœåŠ¡æˆåŠŸå¯åŠ¨ï¼ˆç«¯å£ 8081ï¼‰
2. Flutter åº”ç”¨æˆåŠŸå®‰è£…å¹¶è¿è¡Œ
3. ç½‘ç»œé€šä¿¡æ­£å¸¸
4. åŸºç¡€åŠŸèƒ½ï¼ˆä¼æŸ¥æŸ¥æœç´¢ï¼‰æ­£å¸¸å·¥ä½œ

### ğŸ”„ å¾…æµ‹è¯•
1. åˆ›å»ºç¦»çº¿æ•°æ®å¹¶è§‚å¯ŸåŒæ­¥è¡Œä¸º
2. æµ‹è¯• API Client ä¸å¯ç”¨åœºæ™¯
3. æµ‹è¯• API Client æ¢å¤åœºæ™¯
4. æµ‹è¯•åº”ç”¨é‡å¯åçš„çŠ¶æ€æ¢å¤

## ä»£ç éªŒè¯

### ApiClientMonitor å®ç°
```dart
class ApiClientMonitor extends ChangeNotifier {
  SyncApiClient? _client;
  
  bool get isClientAvailable => _client != null;
  
  void setClient(SyncApiClient client) {
    _client = client;
    notifyListeners();  // âœ… é€šçŸ¥ç›‘å¬è€…
  }
  
  void clearClient() {
    _client = null;
    notifyListeners();  // âœ… é€šçŸ¥ç›‘å¬è€…
  }
}
```

### SyncService é›†æˆ
```dart
// âœ… æ„é€ å‡½æ•°æ¥å— ApiClientMonitor
SyncService({
  required AppDatabase db,
  required ApiClientMonitor clientMonitor,
  ...
})

// âœ… ç›‘å¬ Client çŠ¶æ€å˜åŒ–
void _init() {
  _clientMonitor.addListener(_onClientAvailabilityChanged);
  ...
}

// âœ… Client æ¢å¤æ—¶è‡ªåŠ¨è§¦å‘åŒæ­¥
void _onClientAvailabilityChanged() {
  if (_clientMonitor.isClientAvailable) {
    triggerSync(reason: 'API Client æ¢å¤');
  } else {
    _cancelPendingOperations();
  }
}

// âœ… åŒæ­¥å‰æ£€æŸ¥ Client å¯ç”¨æ€§
Future<void> _processSyncItem(SyncQueueItemData item) async {
  final apiClient = _clientMonitor.client;
  if (apiClient == null) {
    throw ClientUnavailableException();  // âœ… æ˜ç¡®å¼‚å¸¸
  }
  ...
}

// âœ… æ•è·å¼‚å¸¸å¹¶ä¿ç•™é˜Ÿåˆ—é¡¹
on ClientUnavailableException catch (e) {
  await _dao.updateItemStatus(item.id, SyncQueueItemStatus.pending);
  throw ClientUnavailableException('API Client ä¸å¯ç”¨ï¼Œå·²æš‚åœåŒæ­¥');
}
```

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ‰‹åŠ¨æµ‹è¯•ç¦»çº¿æ•°æ®åŒæ­¥**
   - åœ¨åº”ç”¨ä¸­åˆ›å»ºä¸€ä¸ªæ–°å®¢æˆ·
   - è§‚å¯ŸåŒæ­¥é˜Ÿåˆ—å’Œæ—¥å¿—
   - éªŒè¯æ•°æ®æ˜¯å¦æˆåŠŸåŒæ­¥

2. **æµ‹è¯• API Client ç”Ÿå‘½å‘¨æœŸ**
   - éœ€è¦åœ¨ç™»å½•/ç™»å‡ºæµç¨‹ä¸­é›†æˆ `setClient()` å’Œ `clearClient()`
   - å½“å‰ä»£ç ä¸­å¯èƒ½è¿˜æœªå®Œå…¨é›†æˆ

3. **å®Œå–„é›†æˆ**
   - åœ¨ `AuthProvider` ä¸­è°ƒç”¨ `ApiClientMonitor.setClient()`
   - åœ¨ç™»å‡ºæ—¶è°ƒç”¨ `ApiClientMonitor.clearClient()`

## ç»“è®º

**æ ¸å¿ƒåŠŸèƒ½å·²å®ç°**:
- âœ… ApiClientMonitor ç±»å®ç°å®Œæ•´
- âœ… SyncService é›†æˆæ­£ç¡®
- âœ… å¼‚å¸¸å¤„ç†æœºåˆ¶å®Œå–„
- âœ… è‡ªåŠ¨æ¢å¤æœºåˆ¶å°±ç»ª

**å¾…å®Œå–„**:
- ğŸ”„ éœ€è¦åœ¨è®¤è¯æµç¨‹ä¸­é›†æˆ Monitor
- ğŸ”„ éœ€è¦è¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
- ğŸ”„ éœ€è¦éªŒè¯æ‰€æœ‰è¾¹ç•Œæƒ…å†µ

**é£é™©è¯„ä¼°**: ä½
- ä»£ç å®ç°ç¬¦åˆè®¾è®¡è¦æ±‚
- é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±

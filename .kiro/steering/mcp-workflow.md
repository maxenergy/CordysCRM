# MCP 工作流规则

## 代码修改前的必要步骤

每次修改代码前，必须执行以下步骤：

1. **查询 Claude-Mem** - 搜索相关经验和历史实现
   - 使用自然语言查询搜索相关问题的解决经验
   - 查看过往类似功能的实现方式
   - 了解之前遇到的问题和解决方案

2. **与 Codex MCP 协作** - 获取代码实现建议
   - 将需求和初步分析发送给 codex
   - 获取代码原型（unified diff patch）
   - 基于原型重写生产级代码

## 代码修改后的必要步骤

完成重要任务后，记忆会自动保存：

1. **让会话自然完成** - 生成高质量摘要
   - Claude-Mem 会在会话结束时自动生成摘要
   - 摘要包含关键决策、实现细节和遇到的问题
   - 这些摘要可在未来会话中搜索和引用

2. **使用描述性提示** - 创建更好的观察
   - 清晰描述你在做什么
   - 说明为什么做出某个决策
   - 记录遇到的问题和解决方案

## Claude-Mem 查询示例

| 查询类型 | 示例 | 用途 |
|---------|------|------|
| 最近工作 | "上次会话我们做了什么？" | 恢复工作上下文 |
| 实现细节 | "我们是如何实现身份验证的？" | 了解过往实现 |
| 文件历史 | "worker-service.ts 做了哪些修改？" | 追踪文件变更 |
| 问题解决 | "我们是如何修复内存泄漏的？" | 学习解决方案 |
| 决策记录 | "关于 API 设计我们做了哪些决策？" | 理解设计决策 |

## 前端测试规则

如果需要测试前端功能，必须使用 chrome-devtools MCP 进行自动化测试：

1. 使用 `list_pages` 查看当前打开的页面
2. 使用 `navigate_page` 导航到目标页面
3. 使用 `take_snapshot` 获取页面快照
4. 使用 `click`、`fill` 等工具进行交互测试
5. 使用 `take_screenshot` 截图记录测试结果

## 工作流程总结

```
需求分析 → Claude-Mem查询 → Codex协作 → 代码实现 → Codex review → 会话完成（自动摘要）
                                          ↓
                              前端测试 → chrome-devtools
```

## 何时查询 Claude-Mem

**必须查询记忆的场景：**
- 开始新功能开发前（了解相关历史）
- 修复 bug 前（查看是否有类似问题）
- 架构决策前（回顾过往决策）
- 集成第三方服务前（查看过往集成经验）
- 性能优化前（了解之前的优化方法）

**查询示例：**
- "我们之前是如何处理用户认证的？"
- "上次集成支付 API 遇到了什么问题？"
- "数据库架构是如何演进的？"
- "之前的性能优化做了哪些改动？"

## Spec 任务开始前的必要步骤

每次开始执行 `.kiro/specs/*/tasks.md` 中的任务前，必须执行以下步骤：

1. **查询 Claude-Mem** - 了解相关历史
   - 搜索与任务相关的过往实现
   - 查看类似功能的实现方式
   - 了解可能遇到的问题

2. **与 Codex MCP 或 Gemini MCP 详细讨论** - 细化功能和逻辑
   - 将任务描述、相关需求和设计文档发送给 codex 或 gemini
   - 讨论任务应该包含的细化功能点
   - 明确实现逻辑、边界条件和异常处理
   - 确认技术方案和实现细节

3. **讨论内容应包括：**
   - 功能的具体实现步骤
   - 需要考虑的边界情况
   - 错误处理策略
   - 与现有代码的集成方式
   - 测试要点

4. **讨论完成标志：**
   - 形成清晰的实现计划
   - 明确所有细节问题
   - 获得代码原型（如需要）

**示例流程：**
```
读取任务 → Claude-Mem查询 → 与 codex/gemini 讨论细化功能 → 确认实现方案 → 开始编码
```

## Claude-Mem 自动功能

以下功能自动运行，无需手动操作：

- **会话开始**：自动注入最近 50 条相关观察
- **工具使用**：自动捕获所有工具执行（文件读取、搜索、命令等）
- **会话结束**：自动生成会话摘要
- **语义搜索**：所有观察自动索引，支持自然语言搜索

## 隐私保护

使用 `<private>` 标签保护敏感信息：

```
<private>
API_KEY=sk-1234567890abcdef
DATABASE_PASSWORD=secret-password
</private>
```

标签内的内容：
- 不会被存储
- 不会发送到 AI 模型
- 不会出现在搜索结果中

## 配置调整

根据项目需要调整 `.kiro/settings/claude-mem.json`：

- **CLAUDE_MEM_CONTEXT_OBSERVATIONS**: 调整注入的观察数量（默认 50）
  - 复杂项目：增加到 100
  - 简单项目：减少到 20-30
  
- **CLAUDE_MEM_LOG_LEVEL**: 调整日志级别
  - 调试：`DEBUG`
  - 正常：`INFO`
  - 安静：`WARN` 或 `ERROR`

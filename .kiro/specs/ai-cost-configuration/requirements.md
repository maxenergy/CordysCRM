# Requirements Document: AI Cost Configuration & Pricing Strategy

## Introduction

The current AI service implementation uses a hardcoded cost calculation (`$0.01/1000 tokens`) for all AI models. This is inaccurate because different AI providers and models have vastly different pricing structures, often with separate rates for input tokens versus output tokens. This specification addresses this P1 issue by implementing a flexible, database-backed pricing configuration system.

## Glossary

- **AI_Provider**: External AI service provider (e.g., OpenAI, Aliyun, Claude)
- **AI_Model**: Specific model within a provider (e.g., gpt-4, gpt-3.5-turbo, qwen-max)
- **Input_Tokens**: Tokens in the prompt sent to the AI model
- **Output_Tokens**: Tokens in the response generated by the AI model
- **Token_Price**: Cost per 1000 tokens (separate for input and output)
- **AI_Generation_Log**: Audit log of all AI generation requests with cost tracking

## Requirements

### Requirement 1: Flexible Pricing Configuration

**User Story:** As a system administrator, I want to configure AI model pricing in the database, so that I can update prices without redeploying the application.

#### Acceptance Criteria

1. THE System SHALL store AI model pricing in a database table
2. WHEN a new AI model is added, THE System SHALL allow administrators to configure its pricing
3. WHEN pricing changes, THE System SHALL allow administrators to update prices without code changes
4. THE System SHALL support different pricing for input tokens and output tokens

### Requirement 2: Accurate Cost Calculation

**User Story:** As a finance manager, I want accurate cost tracking for AI usage, so that I can budget and bill correctly.

#### Acceptance Criteria

1. WHEN calculating AI generation cost, THE System SHALL use the configured price for the specific provider and model
2. WHEN a model has separate input and output prices, THE System SHALL calculate cost as: `(inputTokens * inputPrice / 1000) + (outputTokens * outputPrice / 1000)`
3. WHEN a model's pricing is not configured, THE System SHALL use a safe default price and log a warning
4. THE System SHALL use BigDecimal for all cost calculations to ensure precision

### Requirement 3: Multi-Provider Support

**User Story:** As a developer, I want to support multiple AI providers with different pricing models, so that we can choose the most cost-effective option.

#### Acceptance Criteria

1. THE System SHALL support pricing configuration for multiple providers (OpenAI, Aliyun, Claude, etc.)
2. WHEN a provider is added, THE System SHALL allow configuring pricing for all its models
3. WHEN switching providers, THE System SHALL use the correct pricing for the new provider
4. THE System SHALL support different currencies (USD, CNY) for different providers

### Requirement 4: Pricing Cache

**User Story:** As a system administrator, I want pricing data to be cached, so that every AI request doesn't query the database.

#### Acceptance Criteria

1. WHEN the service starts, THE System SHALL load all pricing configurations into memory
2. WHEN pricing is updated in the database, THE System SHALL refresh the cache within 1 hour
3. WHEN calculating cost, THE System SHALL use the cached pricing data
4. THE System SHALL provide a manual cache refresh endpoint for administrators

### Requirement 5: Cost Audit Trail

**User Story:** As a compliance officer, I want all AI costs to be logged with the pricing used, so that I can audit billing accuracy.

#### Acceptance Criteria

1. WHEN an AI generation completes, THE System SHALL log the cost calculation details
2. THE log SHALL include: provider, model, input tokens, output tokens, input price, output price, total cost
3. WHEN pricing changes, THE System SHALL use the pricing active at the time of generation
4. THE System SHALL retain cost logs for at least 1 year

### Requirement 6: Fallback Pricing

**User Story:** As a developer, I want the system to handle missing pricing gracefully, so that AI features don't break when new models are added.

#### Acceptance Criteria

1. WHEN a model's pricing is not configured, THE System SHALL use a default fallback price
2. WHEN using fallback pricing, THE System SHALL log a warning with the model details
3. THE default fallback price SHALL be configurable via application properties
4. THE System SHALL continue to function even with fallback pricing

### Requirement 7: Pricing History

**User Story:** As a finance manager, I want to track pricing changes over time, so that I can analyze cost trends.

#### Acceptance Criteria

1. WHEN pricing is updated, THE System SHALL record the change with timestamp
2. THE System SHALL maintain a history of all pricing changes
3. WHEN analyzing costs, THE System SHALL be able to retrieve historical pricing
4. THE System SHALL support querying pricing effective at a specific date

### Requirement 8: API for Pricing Management

**User Story:** As a system administrator, I want a REST API to manage pricing, so that I can automate pricing updates.

#### Acceptance Criteria

1. THE System SHALL provide an API endpoint to list all pricing configurations
2. THE System SHALL provide an API endpoint to create new pricing configurations
3. THE System SHALL provide an API endpoint to update existing pricing configurations
4. THE System SHALL provide an API endpoint to delete pricing configurations
5. THE System SHALL require admin authentication for all pricing management endpoints

## Non-Functional Requirements

### Accuracy
- Cost calculations SHALL be accurate to 6 decimal places
- BigDecimal SHALL be used for all monetary calculations

### Performance
- Pricing cache lookup SHALL complete in < 1ms
- Cache refresh SHALL complete in < 100ms
- Database queries for pricing SHALL use indexes

### Scalability
- The system SHALL support at least 100 different model configurations
- Pricing cache SHALL support concurrent access from multiple threads

### Maintainability
- Pricing configuration SHALL be stored in a normalized database table
- SQL migrations SHALL be provided for schema changes
- API documentation SHALL be provided for pricing management endpoints

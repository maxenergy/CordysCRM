# 批量导入日期格式修复测试指南

## 测试目标

验证批量导入企业信息时，日期字段能够正确转换和存储，不再出现 `Incorrect date value` 错误。

## 前置条件

1. 后端服务已重启（包含修复代码）
2. Flutter 应用已重新安装到设备
3. 已登录系统
4. 有可用的企业数据进行导入

## 测试步骤

### 1. 准备测试数据

确保测试数据包含成立日期字段（时间戳格式）：

```json
{
  "companyName": "测试企业有限公司",
  "creditCode": "91110000MA01234567",
  "legalPerson": "张三",
  "registeredCapital": 1000.00,
  "establishmentDate": 976464000000,  // 2000-12-11
  "address": "北京市朝阳区测试路123号",
  "industry": "软件和信息技术服务业",
  "status": "存续"
}
```

### 2. 单个企业导入测试

**步骤**：
1. 打开 Flutter 应用
2. 进入"企业搜索"页面
3. 搜索一个企业（例如：阿里巴巴）
4. 点击搜索结果
5. 在预览页面点击"导入"按钮

**预期结果**：
- ✅ 导入成功，显示"导入成功"提示
- ✅ 企业信息保存到数据库
- ✅ 成立日期正确显示（例如：2000-12-11）
- ✅ 后端日志无错误

**验证方法**：
```bash
# 查看后端日志
tail -f backend/logs/app.log | grep "reg_date"

# 查询数据库
mysql -u root -p cordys_crm
SELECT id, company_name, reg_date FROM enterprise_profile ORDER BY create_time DESC LIMIT 5;
```

### 3. 批量导入测试

**步骤**：
1. 在企业搜索页面
2. 长按企业列表项进入选择模式
3. 选择多个企业（建议 3-5 个）
4. 点击底部 SelectionBar 的"批量导入"按钮
5. 观察导入进度对话框

**预期结果**：
- ✅ 显示导入进度（例如：正在导入 1/5）
- ✅ 所有企业导入成功
- ✅ 显示导入结果统计（成功 5 个，失败 0 个）
- ✅ 无日期格式错误

**失败场景测试**：
如果某个企业的成立日期为 null 或无效值：
- ✅ 其他字段正常导入
- ✅ 成立日期字段为 NULL
- ✅ 不影响整体导入流程

### 4. 边界条件测试

测试各种日期值：

| 测试场景 | 时间戳值 | 预期日期 | 预期结果 |
|---------|---------|---------|---------|
| 正常日期 | 976464000000 | 2000-12-11 | ✅ 成功 |
| 最小日期 | 0 | 1970-01-01 | ✅ 成功 |
| 未来日期 | 2524608000000 | 2050-01-01 | ✅ 成功 |
| NULL 值 | null | NULL | ✅ 成功 |
| 负数 | -1 | 1969-12-31 | ✅ 成功或 NULL |

### 5. 数据一致性验证

**验证数据库中的日期格式**：

```sql
-- 查看最近导入的企业
SELECT 
    id,
    company_name,
    reg_date,
    DATE_FORMAT(reg_date, '%Y-%m-%d') as formatted_date,
    create_time
FROM enterprise_profile
WHERE create_time > UNIX_TIMESTAMP(NOW() - INTERVAL 1 HOUR) * 1000
ORDER BY create_time DESC;
```

**预期结果**：
- `reg_date` 列显示为日期格式（例如：2000-12-11）
- 不是时间戳数字（例如：976464000000）

### 6. API 响应验证

**测试搜索 API 返回的日期格式**：

```bash
curl -X GET "http://localhost:8081/api/enterprise/search-local?keyword=测试&page=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Organization-Id: YOUR_ORG_ID"
```

**预期响应**：
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "name": "测试企业有限公司",
        "creditCode": "91110000MA01234567",
        "establishDate": "2000-12-11",  // ISO 日期格式
        "source": "local"
      }
    ],
    "total": 1
  }
}
```

## 回归测试

确保修复没有影响其他功能：

### 1. 企业搜索功能
- ✅ 本地搜索正常
- ✅ 外部搜索正常
- ✅ 混合搜索正常
- ✅ 重新搜索正常

### 2. 企业详情展示
- ✅ 成立日期正确显示
- ✅ 其他字段正常显示
- ✅ AI 画像生成正常

### 3. 企业更新功能
- ✅ 更新企业信息时日期字段正常
- ✅ 冲突检测正常工作

## 性能测试

### 批量导入性能

测试大批量导入的性能：

| 数量 | 预期时间 | 实际时间 | 成功率 |
|------|---------|---------|--------|
| 10 个 | < 5s | ___ | ___ |
| 50 个 | < 20s | ___ | ___ |
| 100 个 | < 40s | ___ | ___ |

## 错误处理测试

### 1. 无效时间戳

导入包含无效时间戳的企业：

```json
{
  "companyName": "测试企业",
  "creditCode": "91110000MA01234567",
  "establishmentDate": "invalid"  // 无效值
}
```

**预期结果**：
- ✅ 转换失败时记录警告日志
- ✅ 成立日期字段设置为 NULL
- ✅ 其他字段正常导入
- ✅ 不影响整体导入流程

### 2. 数据库连接失败

模拟数据库连接失败：

**预期结果**：
- ✅ 显示明确的错误提示
- ✅ 不丢失用户数据
- ✅ 可以重试导入

## 测试报告模板

```markdown
## 批量导入日期格式修复测试报告

**测试时间**: YYYY-MM-DD HH:mm:ss
**测试人员**: [姓名]
**测试环境**: 
- 后端版本: [版本号]
- Flutter 版本: [版本号]
- 设备: [设备型号]

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 单个企业导入 | ✅/❌ | |
| 批量导入（5个） | ✅/❌ | |
| 批量导入（50个） | ✅/❌ | |
| NULL 日期处理 | ✅/❌ | |
| 无效日期处理 | ✅/❌ | |
| 数据库日期格式 | ✅/❌ | |
| API 响应格式 | ✅/❌ | |
| 企业搜索功能 | ✅/❌ | |
| 企业详情展示 | ✅/❌ | |

### 发现的问题

1. [问题描述]
   - 重现步骤: ...
   - 预期结果: ...
   - 实际结果: ...
   - 严重程度: P0/P1/P2

### 性能数据

- 单个导入平均耗时: ___ ms
- 批量导入（10个）耗时: ___ s
- 批量导入（50个）耗时: ___ s

### 结论

- [ ] 修复有效，可以发布
- [ ] 需要进一步修复
- [ ] 需要回滚

### 建议

[测试建议和改进意见]
```

## 常见问题

### Q1: 导入时仍然出现日期错误？

**检查清单**：
1. 确认后端已重启并加载新代码
2. 检查 `EnterpriseProfile.regDate` 字段类型是否为 `LocalDate`
3. 查看后端日志是否有转换错误
4. 验证数据库表结构 `reg_date` 列类型为 `DATE`

### Q2: 历史数据的日期显示异常？

**原因**：历史数据可能包含 Long 类型的时间戳

**解决方案**：
```sql
-- 检查异常数据
SELECT id, company_name, reg_date 
FROM enterprise_profile 
WHERE reg_date > '9999-12-31' OR reg_date < '1900-01-01';

-- 如果需要，可以编写数据迁移脚本
```

### Q3: 性能是否受影响？

**答案**：不会。`LocalDate` 与 `Long` 的性能差异可以忽略不计，MyBatis 的类型转换非常高效。

## 相关文档

- [BATCH_IMPORT_DATE_FIX.md](./BATCH_IMPORT_DATE_FIX.md) - 修复详细说明
- [SELECTION_BAR_UI_FIX.md](./SELECTION_BAR_UI_FIX.md) - SelectionBar UI 修复
- [COMPILE_AND_RUN_STATUS.md](../COMPILE_AND_RUN_STATUS.md) - 编译和运行状态

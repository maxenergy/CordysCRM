# 企业批量导入功能测试指南

## 测试环境

- **设备**: PJT110 (Android 15 API 35)
- **应用状态**: 已安装并运行
- **后端服务**: 运行在 localhost:8081

## 快速启动测试

运行测试脚本（自动启动后端和 Flutter）：

```bash
./scripts/test_long_press_fix.sh
```

## 长按手势修复说明 (2024-12-26)

**问题**: 长按企业项无法进入选择模式

**原因**: `InkWell` 的 `onLongPress` 与 `ListView` 的滚动手势冲突（手势竞争）

**修复方案**:
1. 将 `InkWell` 替换为 `GestureDetector`
2. 添加 `behavior: HitTestBehavior.opaque` 确保手势可以被捕获
3. 启用 `debugPrintGestureArenaDiagnostics = true` 诊断手势竞争

**监控日志**:
```bash
# 在新终端运行，查看手势诊断信息
adb logcat -s flutter:I | grep -E '\[Item\]|\[Page\]|\[选择模式\]|Gesture arena'
```

**关键日志标识**:
- `[Item Build]` - 列表项构建
- `[Item] GestureDetector 长按触发` - 长按手势被触发
- `[Page] 长按回调被调用` - 页面接收到长按回调
- `[选择模式]` - 选择模式状态变化
- `Gesture arena` - 手势竞争诊断信息

## 测试前准备

1. 确保后端服务正常运行
2. 确保设备已连接并能访问后端 API
3. 打开应用并登录

## 测试清单

### 1. 搜索企业 ✓

**步骤**:
1. 打开应用，进入"企业搜索"页面
2. 在搜索框输入企业名称（如"科技公司"）
3. 等待搜索结果加载

**预期结果**:
- 显示搜索结果列表
- 每个企业项显示基本信息
- 本地企业显示"已导入" badge

---

### 2. 长按进入选择模式 ✓

**步骤**:
1. 在搜索结果列表中，长按任意一个企业项

**预期结果**:
- 进入选择模式
- 所有企业项左侧显示 Checkbox
- 长按的企业自动被选中（Checkbox 勾选）
- 底部显示选择栏，显示"已选 1"
- 顶部标题变为"选择企业"

---

### 3. 选择多个企业 ✓

**步骤**:
1. 在选择模式下，点击其他企业项

**预期结果**:
- 点击的企业被选中/取消选中
- 底部选择栏实时更新已选数量
- 最多可选择 50 个企业

---

### 4. 测试全选/取消全选 ✓

**步骤**:
1. 点击底部选择栏的"全选"按钮
2. 再次点击"取消全选"按钮

**预期结果**:
- 点击"全选"：所有可选企业被选中（最多50个）
- 本地企业不会被选中
- 点击"取消全选"：所有企业被取消选中
- 按钮文字在"全选"和"取消全选"之间切换

---

### 5. 测试批量导入 ✓

**步骤**:
1. 选择 2-5 个企业
2. 点击底部选择栏的"批量导入 (N)"按钮
3. 在确认对话框中点击"确认"

**预期结果**:
- 显示确认对话框，提示将要导入的企业数量
- 点击确认后显示进度对话框
- 进度对话框显示线性进度条和当前进度（如 "2 / 5"）
- 导入过程中进度实时更新

---

### 6. 验证进度显示 ✓

**步骤**:
1. 观察批量导入过程中的进度对话框

**预期结果**:
- 进度条平滑增长
- 进度文本实时更新（如 "1 / 5" → "2 / 5" → ...）
- 对话框不可取消（导入过程中）

---

### 7. 验证结果摘要 ✓

**步骤**:
1. 等待批量导入完成
2. 查看结果摘要对话框

**预期结果**:
- 显示成功和失败数量（如"成功: 5 / 5"）
- 如果有失败，列出失败企业及错误信息
- 点击"确定"关闭对话框
- 如果全部成功，自动退出选择模式并刷新结果

---

### 8. 测试本地企业不可选 ✓

**步骤**:
1. 在搜索结果中找到本地企业（显示"已导入" badge）
2. 尝试点击该企业的 Checkbox

**预期结果**:
- Checkbox 为禁用状态（灰色）
- 点击后显示 Toast 提示："该企业已在本地库中"
- 企业不会被选中

---

### 9. 测试选择上限 ✓

**步骤**:
1. 选择 50 个企业
2. 尝试选择第 51 个企业

**预期结果**:
- 第 51 个企业无法被选中
- 显示 Toast 提示："最多选择50个企业"
- 已选数量保持为 50

---

### 10. 测试退出选择模式 ✓

**步骤**:
1. 在选择模式下，点击底部选择栏的"取消"按钮
2. 或者点击设备的返回键

**预期结果**:
- 退出选择模式
- Checkbox 消失
- 底部选择栏消失
- 顶部标题恢复为"企业搜索"
- 所有选择状态被清除

---

### 11. 测试新搜索时清除选择 ✓

**步骤**:
1. 在选择模式下，选择几个企业
2. 在搜索框输入新的关键词进行搜索

**预期结果**:
- 自动退出选择模式
- 显示新的搜索结果
- 之前的选择状态被清除

---

## 已知问题

无

## 测试结果

- [ ] 所有测试项通过
- [ ] 发现问题（请在下方记录）

## 问题记录

（用户测试时发现的问题记录在此）

---

## 测试完成后

请告知测试结果，包括：
1. 哪些功能正常工作
2. 哪些功能有问题
3. 任何意外行为或建议

测试完成后，我将进行代码审核并提交到 Git。

# 批量导入 UI 改进报告

## 问题描述

用户反馈：在企业搜索页面中，"多选，全选，的勾选框没有看到，批量导入也没有"。

## 问题分析

经过代码审查和截图分析，发现：

1. **勾选框已经显示** - 每个企业项左侧都有勾选框
2. **底部选择栏没有显示** - 这是主要问题
3. **功能可发现性差** - 批量导入功能依赖长按手势，用户不容易发现

## 解决方案

### 1. 添加"选择"按钮

在 AppBar 右上角添加明显的"选择"按钮，提高批量导入功能的可发现性。

**修改文件**：`lib/presentation/features/enterprise/enterprise_search_page.dart`

**改进点**：
- 正常状态下，当有搜索结果且存在非本地企业时，显示"选择"按钮
- 点击后进入选择模式（不预选任何项）
- 选择模式下隐藏"选择"按钮，标题改为"选择企业"

### 2. 优化 `enterSelectionMode` 方法

使 `initialSelectedId` 参数变为可选，并添加校验逻辑。

**修改文件**：`lib/presentation/features/enterprise/enterprise_provider.dart`

**改进点**：
- 参数变为可选：`void enterSelectionMode({String? initialSelectedId})`
- 当不传参数时，进入选择模式但不预选任何项
- 当传参数时，校验该企业是否存在且非本地，然后预选
- 进入选择模式时清空上次的导入错误

**安全性改进**：
- 防止长按本地企业绕过限制
- 验证 `initialSelectedId` 是否在当前 `results` 中
- 只有非本地企业才能被预选

### 3. 保持长按快捷方式

更新长按手势调用，使用命名参数。

**修改文件**：`lib/presentation/features/enterprise/widgets/enterprise_search_result_item.dart`

**改进点**：
- 长按某个企业项时，进入选择模式并尝试预选该项
- 如果是本地企业，会进入选择模式但不预选（由 `enterSelectionMode` 校验）

## 功能特性

### 进入选择模式的两种方式

1. **点击"选择"按钮** - 明显的入口，进入选择模式但不预选任何项
2. **长按企业项** - 快捷方式，进入选择模式并预选该项（如果是非本地企业）

### 选择模式功能

1. **全选/取消全选** - 底部选择栏的全选复选框支持三态
   - 未选：所有企业都未选中
   - 全选：所有非本地企业都选中
   - 部分选：部分企业选中（显示为横杠）

2. **批量导入** - 选择企业后点击"批量导入"按钮
   - 显示确认对话框
   - 显示导入进度
   - 显示导入结果摘要（成功/失败）

3. **取消选择** - 点击"取消"按钮退出选择模式

### 限制和保护

1. **本地企业不可选** - 已导入的企业不能再次导入
2. **最多选择 50 个** - 防止一次导入过多企业
3. **校验预选项** - 防止长按本地企业绕过限制

## 测试步骤

1. 打开应用，进入企业搜索页面
2. 搜索企业（例如：激光）
3. 查看搜索结果

### 测试点 1：AppBar "选择"按钮
- AppBar 右上角应该显示"选择"按钮
- 点击"选择"按钮
- 应该进入选择模式
- 每个企业项左侧应该显示勾选框
- 底部应该显示选择栏（取消、全选、批量导入）

### 测试点 2：全选功能
- 点击底部的"全选"复选框
- 所有非本地企业应该被选中
- 再次点击应该取消全选

### 测试点 3：批量导入功能
- 选择几个企业
- 点击"批量导入"按钮
- 应该显示确认对话框
- 确认后应该显示导入进度
- 导入完成后应该显示结果摘要

### 测试点 4：长按快捷方式
- 退出选择模式
- 长按某个非本地企业项
- 应该进入选择模式并预选该企业
- 长按本地企业项
- 应该进入选择模式但不预选（因为本地企业不可选）

### 测试点 5：取消选择
- 点击底部的"取消"按钮
- 应该退出选择模式
- 勾选框应该消失
- 底部选择栏应该消失

### 测试点 6：边界情况
- 当搜索结果全部为本地企业时，"选择"按钮应该隐藏
- 选择达到 50 个上限时，不能再选择更多

## 代码审核

### Gemini 审核意见
- 方案合理，提高了功能可发现性
- 状态管理清晰，使用单一数据源
- UI 交互符合用户习惯

### Codex 审核意见
- 发现了长按本地企业绕过限制的问题
- 建议添加校验逻辑，已修复
- 建议当所有结果都是本地企业时隐藏"选择"按钮，已实现

## 修改的文件

1. `lib/presentation/features/enterprise/enterprise_search_page.dart`
   - 添加"选择"按钮
   - 添加非本地企业检查

2. `lib/presentation/features/enterprise/enterprise_provider.dart`
   - 修改 `enterSelectionMode` 方法签名
   - 添加校验逻辑

3. `lib/presentation/features/enterprise/widgets/enterprise_search_result_item.dart`
   - 更新 `enterSelectionMode` 调用

## 后续建议

1. 考虑添加批量导入的撤销功能
2. 考虑添加批量导入的历史记录
3. 考虑支持跨页面选择（如果实现了分页）

## 相关文档

- [批量导入测试指南](BATCH_IMPORT_TEST_GUIDE.md)
- [企业搜索功能设计](../.kiro/specs/enterprise-batch-import/design.md)
